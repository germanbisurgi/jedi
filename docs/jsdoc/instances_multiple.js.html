<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: instances/multiple.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: instances/multiple.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import Instance from './instance'
import MultipleEditor from '../editors/multiple'
import {
  isSet,
  mergeDeep,
  isArray,
  different,
  isObject,
  notSet, overwriteExistingProperties
} from '../utils'
import Jedi from '../jedi'

/**
 * Represents a MultipleInstance instance.
 * @extends Instance
 */
class MultipleInstance extends Instance {
  setUI () {
    this.ui = new MultipleEditor(this)
  }

  prepare () {
    this.instances = []
    this.activeInstance = null
    this.lastIndex = 0
    this.index = 0
    this.schemas = []
    this.switcherOptionValues = []
    this.switcherOptionsLabels = []

    this.on('set-value', () => {
      this.onSetValue()
    })

    if (isSet(this.schema.if())) {
      const schemaClone = this.schema.clone()
      this.thenSchema = this.schema.then() ? mergeDeep({}, schemaClone, this.schema.then()) : mergeDeep({}, schemaClone)
      this.elseSchema = this.schema.else() ? mergeDeep({}, schemaClone, this.schema.else()) : mergeDeep({}, schemaClone)
      this.schemas.push(this.thenSchema)
      this.schemas.push(this.elseSchema)

      this.schemas.forEach((schema) => {
        delete schema.if
        delete schema.then
        delete schema.else
      })

      this.switcherOptionValues = [0, 1]
      this.switcherOptionsLabels = ['then', 'else']
    } else if (isSet(this.schema.anyOf()) || isSet(this.schema.oneOf())) {
      const schemasOf = isSet(this.schema.anyOf()) ? this.schema.anyOf() : this.schema.oneOf()
      const cloneSchema = this.schema.clone()
      delete cloneSchema['anyOf']
      delete cloneSchema['oneOf']
      delete cloneSchema['options']

      schemasOf.forEach((schema, index) => {
        schema = { ...cloneSchema, ...schema }

        // merge allOf
        if (isSet(schema.allOf) &amp;&amp; schema.options?.mergeAllOf) {
          let merged = {}

          schema.allOf.forEach((allOfSchema) => {
            merged = mergeDeep(merged, allOfSchema)
          })

          schema = merged
        }

        if (isSet(cloneSchema.title)) {
          schema.title = cloneSchema.title
        }

        const switcherOptionsLabel = schema.options?.switcherTitle || 'Option-' + (index + 1)
        this.switcherOptionValues.push(index)
        this.switcherOptionsLabels.push(switcherOptionsLabel)

        this.schemas.push(schema)
      })
    } else if (isArray(this.schema.type())) {
      this.schema.type().forEach((type, index) => {
        const schemaClone = this.schema.clone()

        const schema = {
          ...schemaClone,
          ...{ type: type, title: type[0].toUpperCase() + type.slice(1) }
        }

        if (isSet(schemaClone.title)) {
          schema.title = schemaClone.title
        }

        this.switcherOptionValues.push(index)
        this.switcherOptionsLabels.push(type.charAt(0).toUpperCase() + type.slice(1))

        this.schemas.push(schema)
      })
    } else if (this.schema.typeIs('any') || !this.schema.type()) {
      const schemaClone = this.schema.clone()

      this.schemas = [
        { ...schemaClone, ...{ type: 'string' } },
        { ...schemaClone, ...{ type: 'number' } },
        { ...schemaClone, ...{ type: 'integer' } },
        { ...schemaClone, ...{ type: 'boolean' } },
        { ...schemaClone, ...{ type: 'array' } },
        { ...schemaClone, ...{ type: 'object' } },
        { ...schemaClone, ...{ type: 'null' } }
      ]

      this.schemas.forEach((schema, index) => {
        this.switcherOptionValues.push(index)
      })

      this.switcherOptionsLabels = [
        'String', 'Number', 'Integer', 'Boolean', 'Array', 'Object', 'Null'
      ]
    }

    // Instances
    this.schemas.forEach((schema) => {
      const instance = this.jedi.createInstance({
        jedi: this.jedi,
        schema: schema,
        path: this.path,
        parent: this.parent
      })

      instance.unregister()

      instance.on('change', () => {
        this.emit('change')
        this.switchIf()
      })

      this.instances.push(instance)

      this.register()
    })

    const schemaClone = this.schema.clone()
    const setValue = isObject(schemaClone)

    if (isSet(this.instances[0])) {
      this.switchInstance(0, false, setValue)
    }
  }

  switchInstance (newIndex, triggersChange = true, setValue = true) {
    this.lastIndex = this.index
    this.index = newIndex
    this.activeInstance = this.instances[this.index]

    if (setValue) {
      this.setValue(this.getValue(), triggersChange)
    }
  }

  switchIf () {
    if (isSet(this.schema.if())) {
      const ifIndex = this.getIfIndex(this.getValue())
      const preValue = this.getValue()
      this.switchInstance(ifIndex)
      const currentValue = this.getValue()
      const finalValue = overwriteExistingProperties(currentValue, preValue)
      this.setValue(finalValue, false)
    }
  }

  getIfIndex (value) {
    const ifEditor = new Jedi({ schema: this.schema.if(), startValue: value, refParser: false })
    const ifErrors = ifEditor.getErrors()
    ifEditor.destroy()
    return ifErrors.length === 0 ? 0 : 1
  }

  getFittestIndex (value) {
    let index = 0
    let fittestIndex
    let championErrors

    for (const instance of this.instances) {
      if (instance.instances) {
        instance.setValue(value)
      }

      const instanceErrors = this.jedi.validator.getErrors(value, instance.schema, instance.getKey(), instance.path)

      if (notSet(fittestIndex) || notSet(championErrors)) {
        fittestIndex = index
        championErrors = instanceErrors
      }

      if (instanceErrors.length &lt; championErrors.length) {
        fittestIndex = index
        championErrors = instanceErrors
      }

      index++
    }

    return fittestIndex
  }

  onSetValue () {
    const value = this.value

    // if value matches the active instance type set the value. Else switch to the first
    // instance that match the value.
    if (different(this.activeInstance.getValue(), value)) {
      let fittestIndex

      if (isSet(this.schema.if())) {
        fittestIndex = this.getIfIndex(value)
      } else {
        fittestIndex = this.getFittestIndex(value)
      }

      this.switchInstance(fittestIndex, false)
    }

    this.activeInstance.setValue(value, false)
  }

  getValue () {
    if (!this.activeInstance) {
      return
    }

    return this.activeInstance.getValue()
  }

  destroy () {
    this.instances.forEach((instance) => {
      instance.destroy()
    })

    super.destroy()
  }
}

export default MultipleInstance
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ArrayEditor.html">ArrayEditor</a></li><li><a href="ArrayInstance.html">ArrayInstance</a></li><li><a href="BooleanEditor.html">BooleanEditor</a></li><li><a href="BooleanInstance.html">BooleanInstance</a></li><li><a href="Editor.html">Editor</a></li><li><a href="Instance.html">Instance</a></li><li><a href="Jedi.html">Jedi</a></li><li><a href="MultipleInstance.html">MultipleInstance</a></li><li><a href="NullEditor.html">NullEditor</a></li><li><a href="NullInstance.html">NullInstance</a></li><li><a href="NumberEditor.html">NumberEditor</a></li><li><a href="NumberInstance.html">NumberInstance</a></li><li><a href="ObjectEditor.html">ObjectEditor</a></li><li><a href="ObjectInstance.html">ObjectInstance</a></li><li><a href="RefParser.html">RefParser</a></li><li><a href="StringEditor.html">StringEditor</a></li><li><a href="StringInstance.html">StringInstance</a></li><li><a href="Theme.html">Theme</a></li><li><a href="Validator.html">Validator</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Fri Jul 21 2023 13:10:46 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
