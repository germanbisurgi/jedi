<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Test page for jedi">
  <title>Editor</title>
</head>
<body>

<main id="app" class="container">
  <h1>Editor</h1>

  <div class="row row-between">
    <div class="col-12 col-sm-7">
      <form action="" method="POST">
        <div ref="jediContainer" id="jedi-container"></div>
        <input v-if="options.isEditor" class="btn btn-primary btn-block" type="submit" value="Submit">
      </form>
    </div>
    <div class="col-12 col-sm-5">
      <fieldset class="card card-body">
        <legend>Methods</legend>
        <div class="form-group">
          <label for="editor-value">Value</label>
          <textarea ref="editorValue" class="form-control" id="editor-value" style="font-family: monospace;height: 30vh;"></textarea>
          <button class="btn btn-block" id="set-value" @click="setEditorValue()">Set Value</button>
        </div>
        <div class="form-group">
          <label for="editor-errors">Errors</label>
          <textarea ref="editorErrors" class="form-control" id="editor-errors" style="font-family: monospace;height: 30vh;"></textarea>
        </div>
        <button class="btn btn-block" id="disable-editor" @click="disableEditor()">Disable editor</button>
        <button class="btn btn-block" id="enable-editor" @click="enableEditor()">Enable editor</button>
        <button class="btn btn-block" id="destroy-editor" @click="destroyEditor()">Destroy editor</button>
      </fieldset>

      <fieldset class="card card-body">
        <legend>Options</legend>

        <div class="form-group">
          <input type="checkbox" id="isEditor" v-model="options.isEditor" @change="initEditor()">
          <label for="isEditor"><code>isEditor</code></label>
        </div>

        <div class="form-group">
          <input type="checkbox" id="editableProperties" v-model="options.editableProperties" @change="initEditor()">
          <label for="editableProperties"><code>editableProperties</code></label>
        </div>

        <div class="form-group">
          <input type="checkbox" id="alwaysShowErrors" v-model="options.alwaysShowErrors" @change="initEditor()">
          <label for="alwaysShowErrors"><code>alwaysShowErrors</code></label>
        </div>

        <div class="form-group">
          <input type="checkbox" id="showRequiredOnly" v-model="options.showRequiredOnly" @change="initEditor()">
          <label for="showRequiredOnly"><code>showRequiredOnly</code></label>
        </div>

        <div class="form-group">
          <label for="rootName"><code>rootName</code></label>
          <input class="form-control" id="rootName" v-model="options.rootName" @change="initEditor()">
        </div>

        <div class="form-group">
          <label for="theme"><code>theme</code></label>
          <select class="form-control" id="theme" v-model="options.theme" @change="reload()">
            <option v-for="theme in themes" :value="theme">{{ theme }}</option>
          </select>
        </div>

        <div class="form-group" v-if="editor">
          <label for="schema">Schema</label>
          <textarea class="form-control" id="schema" style="font-family: monospace; height: 200px;">{{ JSON.stringify(editor.schema.clone(), null, 2) }}</textarea>
        </div>

        <div class="form-group">
          <label for="schemas">Schemas</label>
          <select ref="schema" class="form-control" id="schemas" @change="switchSchema()">
            <option v-for="option in schemas" :value="option.url">{{ option.name }}</option>
          </select>
        </div>
      </fieldset>
    </div>
  </div>
</main>

<script src="js/vue.js"></script>
<script src="js/jedi.js"></script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    new Vue({
      el: '#app',
      data() {
        return {
          editor: null,
          theme: 'wireframe',
          themes: [
            'bootstrap5',
            'bootstrap4',
            'bootstrap3',
            'wireframe',
            'barebones'
          ],
          schemas: [
            {
              name: 'editors/all',
              url: './json/editors/all.json'
            },
            {
              name: 'editors/array',
              url: './json/editors/array.json'
            },
            {
              name: 'editors/boolean',
              url: './json/editors/boolean.json'
            },
            {
              name: 'editors/integer',
              url: './json/editors/integer.json'
            },
            {
              name: 'editors/null',
              url: './json/editors/null.json'
            },
            {
              name: 'editors/number',
              url: './json/editors/number.json'
            },
            {
              name: 'editors/object',
              url: './json/editors/object.json'
            },
            {
              name: 'editors/string',
              url: './json/editors/string.json'
            },
            {
              name: 'examples/login',
              url: './json/examples/login.json'
            },
            {
              name: 'validator/additionalProperties',
              url: './json/validator/additionalProperties.json'
            },
            {
              name: 'validator/allOf',
              url: './json/validator/allOf.json'
            },
            {
              name: 'validator/anyOf',
              url: './json/validator/anyOf.json'
            },
            {
              name: 'validator/const',
              url: './json/validator/const.json'
            },
            {
              name: 'validator/dependentRequired',
              url: './json/validator/dependentRequired.json'
            },
            {
              name: 'validator/enum',
              url: './json/validator/enum.json'
            },
            {
              name: 'validator/exclusiveMaximum',
              url: './json/validator/exclusiveMaximum.json'
            },
            {
              name: 'validator/exclusiveMinimum',
              url: './json/validator/exclusiveMinimum.json'
            },
            {
              name: 'validator/format',
              url: './json/validator/format.json'
            },
            {
              name: 'validator/if',
              url: './json/validator/if.json'
            },
            {
              name: 'validator/maxItems',
              url: './json/validator/maxItems.json'
            },
            {
              name: 'validator/maxLength',
              url: './json/validator/maxLength.json'
            },
            {
              name: 'validator/maxProperties',
              url: './json/validator/maxProperties.json'
            },
            {
              name: 'validator/maximum',
              url: './json/validator/maximum.json'
            },
            {
              name: 'validator/minItems',
              url: './json/validator/minItems.json'
            },
            {
              name: 'validator/minLength',
              url: './json/validator/minLength.json'
            },
            {
              name: 'validator/minProperties',
              url: './json/validator/minProperties.json'
            },
            {
              name: 'validator/minimum',
              url: './json/validator/minimum.json'
            },
            {
              name: 'validator/multipleOf',
              url: './json/validator/multipleOf.json'
            },
            {
              name: 'validator/not',
              url: './json/validator/not.json'
            },
            {
              name: 'validator/oneOf',
              url: './json/validator/oneOf.json'
            },
            {
              name: 'validator/pattern',
              url: './json/validator/pattern.json'
            },
            {
              name: 'validator/patternProperties',
              url: './json/validator/patternProperties.json'
            },
            {
              name: 'validator/required',
              url: './json/validator/required.json'
            },
            {
              name: 'validator/type',
              url: './json/validator/type.json'
            },
            {
              name: 'validator/uniqueItems',
              url: './json/validator/uniqueItems.json'
            },
            {
              name: 'validator/message',
              url: './json/validator/message.json'
            },
            {
              name: 'meta-schema',
              url: './json/meta-schema.json'
            },
            {
              name: 'europass-xml-3.3.0',
              url: './json/europass.json'
            }
          ],
          options: {
            isEditor: true,
            container: document.querySelector('#jedi-container'),
            editableProperties: true,
            alwaysShowErrors: false,
            showRequiredOnly: false,
            theme: 'wireframe',
            rootName: 'root',
            schema: {}
          }
        }
      },
      mounted() {
        this.options.container = document.querySelector('#jedi-container')
        this.switchSchema()
        const theme = this.getQueryParam('theme')

        if (theme) {
          this.theme = theme
          this.options.theme = theme
        }
      },
      methods: {
        initEditor() {
          if (this.editor) {
            this.editor.destroy()
          }

          this.editor = new Jedi(this.options)
          window.editor = this.editor

          this.editor.on('change', () => {
            this.$refs.editorValue.value = JSON.stringify(this.editor.getValue(), null, 2)
            this.$refs.editorErrors.value = JSON.stringify(this.editor.validate(), null, 2)
          })

          this.$refs.editorValue.value = JSON.stringify(this.editor.getValue(), null, 2)
          this.$refs.editorErrors.value = JSON.stringify(this.editor.validate(), null, 2)

          this.registerThemeAssets()
        },
        destroyEditor() {
          this.editor.destroy()
        },
        enableEditor() {
          this.editor.enable()
        },
        disableEditor() {
          this.editor.disable()
        },
        setEditorValue() {
          this.editor.setValue(JSON.parse(this.$refs.editorValue.value))
        },
        reload() {
          console.log(this.theme)
          const newUrl = window.location.origin + "?theme=" + this.options.theme;
          window.open(newUrl, '_self')
        },
        registerThemeAssets() {
          let stylesheets = []
          let scripts = []

          switch (this.options.theme) {
            case 'wireframe':
              stylesheets = ['./css/main.css']
              scripts = ['./js/wireframe.js']
              break
            case 'bootstrap3':
              stylesheets = ['https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css']
              scripts = [
                'https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js',
                'https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js'
              ]
              break
            case 'bootstrap4':
              stylesheets = ['https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css']
              scripts = [
                'https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js',
                'https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js',
                'https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js'
              ]
              break
            case 'bootstrap5':
              stylesheets = ['https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css']
              scripts = ['https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js']
              break
          }

          this.registerStylesheets(stylesheets)
          this.registerScripts(scripts)
        },
        registerStylesheets(stylesheets) {
          stylesheets.forEach((href) => {
            const stylesheet = document.createElement('link')
            stylesheet.setAttribute('rel', 'stylesheet')
            stylesheet.setAttribute('href', href)
            document.head.appendChild(stylesheet)
          })
        },
        registerScripts(scripts, index = 0) {
          const script = document.createElement('script')
          document.body.appendChild(script)

          script.onload = () => {
            index++

            if (scripts[index]) {
              this.registerScripts(scripts, index)
            }
          }

          script.src = scripts[index]
        },
        async switchSchema() {
          const url = this.$refs.schema.value
          const response = await fetch(url);
          this.options.schema = await response.json()
          this.initEditor()
        },
        getQueryParam(name) {
          const match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
          return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
        }
      }
    })
  })
</script>
</body>
</html>
